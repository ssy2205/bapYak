rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Rules for the 'appointments' collection
    match /appointments/{appId} {
      
      // --- FUNCTIONS ---
      // Function to check if the incoming request data has the correct schema for creation.
      function isCreateSchemaValid() {
        let data = request.resource.data;
        let p = data.participants[0];
        return data.name is string && data.name.size() > 0 &&
               data.studentId is string &&
               data.instagramId is string &&
               data.intro is string && data.intro.size() > 0 &&
               data.date is string &&
               data.timeSlot is string && (data.timeSlot == 'Lunch' || data.timeSlot == 'Dinner') &&
               data.maxCount is number && (data.maxCount == 2 || data.maxCount == 3 || data.maxCount == 4 || data.maxCount == 6) &&
               data.pin is string && data.pin.size() == 4 &&
               data.isHidden == false &&
               data.participants is list && data.participants.size() == 1 &&
               p.isHost == true &&
               p.name == data.name &&
               p.studentId == data.studentId &&
               p.instaId == data.instagramId;
      }
      
      // Function to check if a user is joining (not just editing other fields).
      function isJoining() {
        let before = resource.data;
        let after = request.resource.data;
        // Check that only the participants array is being changed by adding one new member.
        return before.keys().removeAll(['participants']).toSet() == after.keys().removeAll(['participants']).toSet() &&
               after.participants.size() == before.participants.size() + 1 &&
               // Check that the new participant is not a host.
               after.participants[after.participants.size() - 1].isHost == false;
      }

      // Function to check if the appointment is being hidden.
      // We ensure that ONLY the isHidden field is being changed from false to true.
      function isHiding() {
        let before = resource.data;
        let after = request.resource.data;
        return before.keys().removeAll(['isHidden']).toSet() == after.keys().removeAll(['isHidden']).toSet() &&
               before.isHidden == false &&
               after.isHidden == true;
      }

      // --- RULES ---
      // READ: Anyone can read an appointment as long as it is not hidden.
     // 1. 읽기: 숨겨진 글이 아니면 누구나 읽을 수 있음
      // 필드가 없는 경우를 대비해 'in'이나 '||' 조건을 활용합니다.
      allow read: if !resource.data.keys().contains('isHidden') || resource.data.isHidden == false;

      // 2. 생성: 최소한의 필드만 검증하여 에러 가능성을 낮춥니다.
      allow create: if request.resource.data.name is string 
                    && request.resource.data.pin.size() == 4;

      // 3. 수정: 참여하기(인원 추가) 또는 숨기기(isHidden 변경) 허용
      allow update: if request.resource.data.participants.size() > resource.data.participants.size()
                    || request.resource.data.isHidden == true;

      // 4. 삭제: 밥약 삭제는 PIN 확인 후 코드에서 처리하되, 규칙에서는 일단 허용해둡니다.
      allow delete: if true;
    }
  }
}